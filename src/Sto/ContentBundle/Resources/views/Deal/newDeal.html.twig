{% extends 'StoContentBundle::layout.html.twig' %}
{% from 'MopaBootstrapBundle::flash.html.twig' import flash %}


{% block title %}Новая акция{% endblock %}

{% block header %}<h4>{{ block('title') }}</h4>{% endblock %}

{% block head_style %}
{{ parent() }}
<link href="{{ asset('bundles/stocore/css/select2.css') }}" type="text/css" rel="stylesheet" media="screen" />
{% endblock %}

{% block content %}
<form action="{{ path('company_deal_create' ,{'id': company.id}) }}" method="post" {{ form_enctype(form) }} class="form-horizontal">
    <div class="container">
        {{ form_row(form.name) }}
        {{ form_row(form.description) }}
        {{ form_row(form.type) }}
        <div class=" control-group">
            <label class="control-label required">
                Сроки акции
            </label>
            <div class="controls">
                {{ form_errors(form.startDate) }}
                {{ form_widget(form.startDate) }}
                {{ form_errors(form.endDate) }}
                {{ form_widget(form.endDate) }}
            </div>
        </div>
        <div class=" control-group">
            <label class="control-label required">
                Время акции
            </label>
            <div class="controls">
                {{ form_errors(form.startTime) }}
                {{ form_widget(form.startTime) }}
                {{ form_errors(form.endTime) }}
                {{ form_widget(form.endTime) }}
            </div>
        </div>
        {{ form_row(form.auto) }}
        {{ form_row(form.autoServices) }}
        {{ form_row(form.place) }}
        {{ form_row(form.terms) }}
    </div>
    <hr style="margin: 0 0 20px 0;">
    <div class="container">
        <div class="span2">
            <p>
                Изображения акции</br><small><em>Изображения должны быть пропорции 16:9, не меньше 640 х 360 пикселей</br></br>Формат изображения: JPG, PNG, GIF не более 1Мь</em></small>
                <p>
                </div>
                <div class="span3">
                    <div class="control-group">
                        <div class="control">
                            <img data-image="image1" src="{{ asset('bundles/stocore/images/notimage.png') }}" style="width:120px" class="img-polaroid"/>
                            {{ form_errors(form.image) }}
                            {{ form_widget(form.image) }}
                        </div>
                    </div>
                </div>
                <div class="span3">
                    <div class="control-group">
                        <div class="control">
                            <img data-image="image2" src="{{ asset('bundles/stocore/images/notimage.png') }}" style="width:120px" class="img-polaroid"/>
                            {{ form_errors(form.image2) }}
                            {{ form_widget(form.image2) }}
                        </div>
                    </div>
                </div>
                <div class="span3">
                    <div class="control-group">
                        <div class="control">
                            <img data-image="image3" src="{{ asset('bundles/stocore/images/notimage.png') }}" style="width:120px" class="img-polaroid"/>
                            {{ form_errors(form.image3) }}
                            {{ form_widget(form.image3) }}
                        </div>
                    </div>
                </div>
            </div>
            <hr style="margin: 0 0 20px 0;">
            {{ form_widget(form) }}
            {{ form_rest(form) }}
            <div class="form-actions">
                {% if (activ_deals|length())  < 2 %}

                <input type="submit"  class="btn btn-primary" value="Опубликовать" />
                {% else %}
                {{ flash(true, 'У вас две активных акции. Сохраните как черновик', false, true) }}
                {% endif %}

                <input type="submit" class="btn btn-primary" value="Сохранить черновик" name = 'draft' />
            </div>
        </form>
        <div id="myModal" class="modal hide fade" style = "width:720px;">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
            </div>
            <div class="modal-body ">
              <div id="myMap" style="height:400px;width:670px ;left:5px" ></div>
          </div>
          <div class="modal-footer" >
            <a href="#" id="save_madal"  class="btn btn-primary">Save</a>
        </div>
    </div>
{% endblock %}

{% block foot_script %}
{{ parent() }}
{% javascripts
'bundles/stocore/js/select2.js'
'bundles/stocore/js/bootstrap-inputmask.js'
'bundles/stoadmin/js/script.js'
%}
<script type="text/javascript" src="{{ asset_url }}"></script>
{% endjavascripts %}
<script src="http://api-maps.yandex.ru/2.0/?load=package.full&lang=ru-RU" type="text/javascript"></script>
<script type="text/javascript" >
    $(".select2").select2({width: "50%"});
    $('#sto_content_deal_place').after('<br/><a href="#" ;return false; id="deal_location">По месту размещения компании</a>');

    var gCollection;
    var gps = '{{ company.gps }}';
    var addres;
    var names = [];
    ymaps.ready(init);
    function init(){
        mapCompany = new ymaps.Map ("myMap", {
            center: [gps.split(",")[0], gps.split(",")[1]],
            zoom: 15,
            behaviors: ["default", "scrollZoom"]
        });
        myGeocode(mapCompany.getCenter(),mapCompany);

        mapCompany.events.add('click', function (e) {
            var coords = e.get('coordPosition');
            if (gCollection != null) { mapCompany.geoObjects.remove(gCollection);};
            myGeocode(coords,mapCompany);
        });

        function myGeocode(loc,Map){
            names =[];
            ymaps.geocode(loc).then(function (res) {

                res.geoObjects.each(function (obj) {
                    names.push(obj.properties.get('text'));

                });
                gCollection = new ymaps.Placemark(loc, {
                    iconContent:names[0],
                },
                { preset:'twirl#redStretchyIcon',balloonMaxWidth:'250'}
                );
                Map.geoObjects.add(gCollection);
                gps = loc;
                addres = names[0]
            });
        }

    }
    $("#save_madal").click(function () {
        document.getElementById("sto_content_deal_gps").value =gps;
        document.getElementById("sto_content_deal_place").value =addres;

        $('#myModal').modal('hide');
    });
    $("#deal_location").click(function () {
        document.getElementById("sto_content_deal_place").value ='{{company.address}}';
        document.getElementById("sto_content_deal_gps").value ='{{company.gps}}';
    })
</script>
{% endblock %}
